<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJ SOLUÇÕES - SISTEMA DE GESTÃO</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- jsPDF e autoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-green: #10b981;
            --soft-green: #d1fae5;
            --primary-blue: #3b82f6;
            --soft-blue: #dbeafe;
            --dark-gray: #1f2937;
            --light-gray: #f9fafb;
            --accent-purple: #8b5cf6;
            --accent-orange: #f59e0b;
        }
        * {
            font-family: 'Inter', sans-serif;
        }
        /* CAIXA ALTA em todo o sistema, exceto inputs */
        body, .modal, .card, .navbar, .footer, .btn, th, td, label, h1, h2, h3, h4, h5, h6, span, div {
            text-transform: uppercase;
        }
        input, textarea, select, .form-control, .form-select {
            text-transform: none !important; /* mantém o texto digitado normal */
        }
        body {
            background-color: var(--light-gray);
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-blue)) !important;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.5px;
        }
        .card {
            border-radius: 24px;
            border: none;
            box-shadow: 0 20px 35px -8px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.02);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 30px 45px -12px rgba(16, 185, 129, 0.15), 0 0 0 1px rgba(0,0,0,0.02);
        }
        .btn-success {
            background: linear-gradient(135deg, var(--primary-green), #059669);
            border: none;
            box-shadow: 0 4px 6px -2px rgba(16,185,129,0.3);
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), #2563eb);
            border: none;
            box-shadow: 0 4px 6px -2px rgba(59,130,246,0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            border: none;
            color: white;
        }
        .nav-tabs .nav-link {
            border: none;
            color: var(--dark-gray);
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 100px;
            margin-right: 8px;
            transition: all 0.2s;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, var(--soft-green), var(--soft-blue));
            color: var(--dark-gray);
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(16,185,129,0.1);
        }
        .table thead {
            background: linear-gradient(135deg, var(--primary-green), var(--primary-blue));
            color: white;
            border-radius: 16px 16px 0 0;
        }
        .table thead th {
            border: none;
            padding: 16px;
        }
        .table tbody tr {
            transition: background 0.2s;
        }
        .table tbody tr:hover {
            background: var(--soft-green);
        }
        .footer {
            background: var(--dark-gray);
            color: white;
            padding: 20px 0;
            margin-top: 50px;
        }
        .stat-card {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 20px 35px -8px rgba(0,0,0,0.05);
            border-left: 6px solid var(--primary-green);
            transition: all 0.3s;
        }
        .stat-card:hover {
            transform: scale(1.02);
        }
        .search-box {
            border-radius: 100px;
            border: 1px solid #e5e7eb;
            padding: 12px 20px;
            font-size: 0.95rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .produto-lista {
            max-height: 240px;
            overflow-y: auto;
            border-radius: 20px;
            background: #f9fafb;
            padding: 12px;
        }
        .produto-item {
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 16px;
            transition: background 0.2s;
            margin-bottom: 4px;
        }
        .produto-item:hover {
            background: var(--soft-green);
        }
        .item-venda {
            background: white;
            border-radius: 20px;
            padding: 16px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 6px solid var(--primary-blue);
            box-shadow: 0 4px 8px rgba(0,0,0,0.02);
        }
        .chart-container {
            position: relative;
            height: 280px;
            width: 100%;
        }
        .empresa-header {
            background: white;
            border-radius: 30px;
            padding: 24px 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 30px -10px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02);
        }
        .login-container {
            max-width: 420px;
            margin: 120px auto;
        }
        .badge-quitado {
            background: linear-gradient(135deg, var(--primary-green), #059669);
            color: white;
            padding: 6px 12px;
            border-radius: 100px;
        }
        .badge-pendente {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 6px 12px;
            border-radius: 100px;
        }
        .glass-effect {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.5);
        }
        /* Ajustes para inputs dentro de caixa alta */
        .form-control, .form-select {
            text-transform: none;
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginContainer" class="login-container">
        <div class="card glass-effect p-5">
            <h3 class="text-center mb-4" style="color: var(--primary-green); font-weight: 700;">MJ SOLUÇÕES</h3>
            <div class="mb-4">
                <label class="form-label text-muted">USUÁRIO</label>
                <input type="text" id="loginUser" class="form-control form-control-lg rounded-pill" placeholder=" ">
            </div>
            <div class="mb-4">
                <label class="form-label text-muted">SENHA</label>
                <input type="password" id="loginPass" class="form-control form-control-lg rounded-pill" placeholder=" ">
            </div>
            <button class="btn btn-success w-100 py-3 rounded-pill" onclick="fazerLogin()">ENTRAR</button>
            <div id="loginError" class="text-danger mt-3 text-center"></div>
        </div>
    </div>

    <!-- Sistema Principal (oculto até login) -->
    <div id="mainSystem" style="display: none;">
        <!-- Navbar -->
        <nav class="navbar navbar-dark py-3">
            <div class="container-fluid px-4">
                <span class="navbar-brand">
                    <i class="bi bi-pc-display me-2"></i>MJ SOLUÇÕES
                </span>
                <span class="text-white-50" id="userInfo"></span>
            </div>
        </nav>

        <!-- Dados da Empresa -->
        <div class="container mt-4">
            <div class="empresa-header">
                <div class="row align-items-center">
                    <div class="col-md-3"><i class="bi bi-building me-2" style="color: var(--primary-green);"></i> <strong>MJ SOLUÇÕES</strong></div>
                    <div class="col-md-3"><i class="bi bi-envelope me-2" style="color: var(--primary-blue);"></i> MIGUELNETOMKT@GMAIL.COM</div>
                    <div class="col-md-3"><i class="bi bi-whatsapp me-2" style="color: #25D366;"></i> <a href="https://w.app/t5dzhj" target="_blank" class="text-decoration-none">(85) 9 9815-5652</a></div>
                    <div class="col-md-3"><i class="bi bi-geo-alt me-2" style="color: var(--accent-orange);"></i> R. FRANCISCO LUCAS DE MELO - ARACOIABA</div>
                </div>
            </div>
        </div>

        <!-- Conteúdo principal -->
        <div class="container mt-3">
            <!-- Abas -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="venda-tab" data-bs-toggle="tab" data-bs-target="#venda"><i class="bi bi-cart-plus me-2"></i>VENDA</button></li>
                <li class="nav-item"><button class="nav-link" id="clientes-tab" data-bs-toggle="tab" data-bs-target="#clientes"><i class="bi bi-people me-2"></i>CLIENTES</button></li>
                <li class="nav-item"><button class="nav-link" id="produtos-tab" data-bs-toggle="tab" data-bs-target="#produtos"><i class="bi bi-boxes me-2"></i>PRODUTOS</button></li>
                <li class="nav-item"><button class="nav-link" id="credito-tab" data-bs-toggle="tab" data-bs-target="#credito"><i class="bi bi-credit-card me-2"></i>CRÉDITO</button></li>
                <li class="nav-item"><button class="nav-link" id="gastos-tab" data-bs-toggle="tab" data-bs-target="#gastos"><i class="bi bi-cash-stack me-2"></i>GASTOS</button></li>
                <li class="nav-item"><button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios"><i class="bi bi-file-text me-2"></i>RELATÓRIOS</button></li>
                <li class="nav-item"><button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"><i class="bi bi-bar-chart-line me-2"></i>DASHBOARD</button></li>
            </ul>

            <!-- Conteúdo das abas -->
            <div class="tab-content p-4 border-0 bg-white rounded-4 shadow-sm mt-3" id="myTabContent">
                <!-- ABA VENDA -->
                <div class="tab-pane fade show active" id="venda">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-cart-plus me-2"></i>NOVA VENDA</h4>
                    <div class="row g-4">
                        <div class="col-md-5">
                            <div class="card p-4">
                                <h5 class="mb-3"><i class="bi bi-person me-2" style="color: var(--primary-blue);"></i>CLIENTE</h5>
                                <input type="text" id="buscaClienteVenda" class="form-control rounded-pill mb-2" placeholder="DIGITE O NOME DO CLIENTE..." onkeyup="buscarClientesVenda()">
                                <div id="listaClientesVenda" class="produto-lista mb-2"></div>
                                <input type="hidden" id="clienteIdVenda">
                                <div id="novoClienteVenda" style="display: none;">
                                    <hr>
                                    <h6 class="fw-bold">CADASTRAR NOVO CLIENTE</h6>
                                    <input type="text" id="novoClienteNome" class="form-control rounded-pill mb-2" placeholder="NOME">
                                    <input type="text" id="novoClienteEndereco" class="form-control rounded-pill mb-2" placeholder="ENDEREÇO">
                                    <input type="text" id="novoClienteCidade" class="form-control rounded-pill mb-2" placeholder="CIDADE">
                                    <input type="text" id="novoClienteEstado" class="form-control rounded-pill mb-2" placeholder="ESTADO">
                                    <input type="text" id="novoClienteCep" class="form-control rounded-pill mb-2" placeholder="CEP">
                                    <input type="email" id="novoClienteEmail" class="form-control rounded-pill mb-2" placeholder="E-MAIL">
                                    <input type="text" id="novoClienteTelefone" class="form-control rounded-pill mb-2" placeholder="TELEFONE">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card p-4">
                                <h5 class="mb-3"><i class="bi bi-search me-2" style="color: var(--primary-blue);"></i>BUSCAR PRODUTOS</h5>
                                <input type="text" id="buscaProduto" class="form-control rounded-pill" placeholder="DIGITE O NOME DO PRODUTO..." onkeyup="filtrarProdutosVenda()">
                                <div id="listaProdutosVenda" class="produto-lista mt-3"></div>
                            </div>
                            <div class="card p-4 mt-4">
                                <h5 class="mb-3"><i class="bi bi-cart-check me-2" style="color: var(--primary-blue);"></i>ITENS DA VENDA</h5>
                                <div id="itensVendaContainer"></div>
                                <hr class="my-3">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-3">
                                        <select id="formaPagamento" class="form-select rounded-pill" onchange="toggleFormaPagamento()">
                                            <option value="dinheiro">DINHEIRO</option>
                                            <option value="cartao">CARTÃO</option>
                                            <option value="pix">PIX</option>
                                            <option value="credito">CRÉDITO DA LOJA</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3" id="trocoArea">
                                        <input type="number" id="valorRecebido" class="form-control rounded-pill" step="0.01" min="0" placeholder="VALOR RECEBIDO" oninput="calcularTroco()">
                                        <small class="text-muted">TROCO: R$ <span id="trocoValor">0,00</span></small>
                                    </div>
                                    <div class="col-md-3" id="creditoArea" style="display: none;">
                                        <input type="number" id="entradaCredito" class="form-control rounded-pill mb-1" step="0.01" min="0" placeholder="ENTRADA (OPCIONAL)">
                                        <select id="parcelasCredito" class="form-select rounded-pill">
                                            <option value="1">1X SEM JUROS</option>
                                            <option value="2">2X SEM JUROS</option>
                                            <option value="3">3X SEM JUROS</option>
                                            <option value="4">4X SEM JUROS</option>
                                            <option value="5">5X SEM JUROS</option>
                                            <option value="6">6X SEM JUROS</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <h4 class="d-inline me-3 fw-bold" style="color: var(--primary-green);">R$ <span id="totalVenda">0,00</span></h4>
                                        <button class="btn btn-success rounded-pill px-4 py-2" onclick="finalizarVenda()"><i class="bi bi-check-lg"></i> FINALIZAR</button>
                                    </div>
                                </div>
                                <div id="vendaMsg" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ABA CLIENTES -->
                <div class="tab-pane fade" id="clientes">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-people me-2"></i>CLIENTES</h4>
                    <div class="d-flex justify-content-between mb-4">
                        <button class="btn btn-success rounded-pill px-4 py-2" data-bs-toggle="modal" data-bs-target="#modalCliente" onclick="limparModalCliente()" id="btnNovoCliente">
                            <i class="bi bi-plus-circle me-2"></i>NOVO CLIENTE
                        </button>
                        <input type="text" id="buscaClientes" class="form-control search-box w-25" placeholder="BUSCAR CLIENTE..." onkeyup="filtrarClientes()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tabelaClientes">
                            <thead>
                                <tr><th>ID</th><th>NOME</th><th>ENDEREÇO</th><th>TELEFONE</th><th>EMAIL</th><th>AÇÕES</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- ABA PRODUTOS -->
                <div class="tab-pane fade" id="produtos">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-boxes me-2"></i>PRODUTOS</h4>
                    <div class="d-flex justify-content-between mb-4">
                        <button class="btn btn-success rounded-pill px-4 py-2" data-bs-toggle="modal" data-bs-target="#modalProduto" onclick="limparModalProduto()" id="btnNovoProduto">
                            <i class="bi bi-plus-circle me-2"></i>NOVO PRODUTO
                        </button>
                        <input type="text" id="buscaProdutos" class="form-control search-box w-25" placeholder="BUSCAR PRODUTO..." onkeyup="filtrarProdutos()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tabelaProdutos">
                            <thead>
                                <tr><th>ID</th><th>NOME</th><th>CUSTO</th><th>PREÇO</th><th>ESTOQUE</th><th>MARGEM</th><th>AÇÕES</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- ABA CRÉDITO DA LOJA -->
                <div class="tab-pane fade" id="credito">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-credit-card me-2"></i>CRÉDITO DA LOJA (FIADO)</h4>
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="stat-card">
                                <h6 class="text-muted">TOTAL A RECEBER</h6>
                                <h2 class="fw-bold" style="color: var(--accent-orange);">R$ <span id="totalCredito">0,00</span></h2>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stat-card">
                                <h6 class="text-muted">CLIENTES COM DÉBITO</h6>
                                <h2 class="fw-bold" style="color: var(--primary-blue);"><span id="totalClientesDebito">0</span></h2>
                            </div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <input type="text" id="buscaCredito" class="form-control search-box w-50" placeholder="BUSCAR CLIENTE..." onkeyup="filtrarCreditos()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tabelaCredito">
                            <thead>
                                <tr><th>CLIENTE</th><th>TOTAL</th><th>ENTRADA</th><th>PARCELAS</th><th>VALOR PARCELA</th><th>PARCELAS PAGAS</th><th>SALDO</th><th>STATUS</th><th>AÇÕES</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- ABA GASTOS -->
                <div class="tab-pane fade" id="gastos">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-cash-stack me-2"></i>CONTROLE DE GASTOS</h4>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card p-4">
                                <h5 class="text-success mb-3"><i class="bi bi-arrow-down-circle me-2"></i>ENTRADAS</h5>
                                <button class="btn btn-outline-success rounded-pill mb-3 w-100" data-bs-toggle="modal" data-bs-target="#modalGasto" onclick="limparModalGasto('entrada')" id="btnNovaEntrada">
                                    <i class="bi bi-plus me-2"></i>NOVA ENTRADA
                                </button>
                                <div id="listaEntradas"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-4">
                                <h5 class="text-danger mb-3"><i class="bi bi-arrow-up-circle me-2"></i>SAÍDAS</h5>
                                <button class="btn btn-outline-danger rounded-pill mb-3 w-100" data-bs-toggle="modal" data-bs-target="#modalGasto" onclick="limparModalGasto('saida')" id="btnNovaSaida">
                                    <i class="bi bi-plus me-2"></i>NOVA SAÍDA
                                </button>
                                <div id="listaSaidas"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ABA RELATÓRIOS -->
                <div class="tab-pane fade" id="relatorios">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-file-text me-2"></i>RELATÓRIOS</h4>
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="fw-semibold">TIPO</label>
                            <select id="relTipo" class="form-select rounded-pill">
                                <option value="vendas">VENDAS</option>
                                <option value="estoque">ESTOQUE</option>
                                <option value="entradas">ENTRADAS</option>
                                <option value="saidas">SAÍDAS</option>
                                <option value="credito">CRÉDITO (FIADO)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="fw-semibold">DATA INÍCIO</label>
                            <input type="date" id="relInicio" class="form-control rounded-pill">
                        </div>
                        <div class="col-md-3">
                            <label class="fw-semibold">DATA FIM</label>
                            <input type="date" id="relFim" class="form-control rounded-pill">
                        </div>
                        <div class="col-md-4 d-flex align-items-end gap-2">
                            <button class="btn btn-success rounded-pill px-4 py-2" onclick="gerarRelatorio()"><i class="bi bi-search me-2"></i>GERAR</button>
                            <button class="btn btn-primary rounded-pill px-4 py-2" onclick="exportarPDF()"><i class="bi bi-file-pdf me-2"></i>PDF</button>
                            <button class="btn btn-success rounded-pill px-4 py-2" onclick="exportarExcel()"><i class="bi bi-file-excel me-2"></i>EXCEL</button>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="d-flex justify-content-end mb-3">
                        <button class="btn btn-warning rounded-pill px-4 py-2" onclick="fecharMes()"><i class="bi bi-calendar-check me-2"></i>FECHAR MÊS (GERAR PDF E LIMPAR)</button>
                    </div>
                    <div id="relatorioResultado" class="mt-3"></div>
                </div>

                <!-- ABA DASHBOARD -->
                <div class="tab-pane fade" id="dashboard">
                    <h4 class="mb-4" style="color: var(--primary-green); font-weight: 600;"><i class="bi bi-bar-chart-line me-2"></i>DASHBOARD</h4>
                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6 class="text-muted">VENDAS (MÊS)</h6>
                                <h3 class="fw-bold" style="color: var(--primary-green);">R$ <span id="totalVendasMes">0,00</span></h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6 class="text-muted">CUSTO (MÊS)</h6>
                                <h3 class="fw-bold text-danger">R$ <span id="totalCustoMes">0,00</span></h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6 class="text-muted">LUCRO (MÊS)</h6>
                                <h3 class="fw-bold" style="color: var(--primary-blue);">R$ <span id="totalLucroMes">0,00</span></h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h6 class="text-muted">ESTOQUE (ITENS)</h6>
                                <h3 class="fw-bold" style="color: var(--primary-green);"><span id="totalEstoqueItens">0</span></h3>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-5 g-4">
                        <div class="col-md-6">
                            <div class="card p-4">
                                <h5 class="text-center mb-4">VENDAS POR DIA (ÚLTIMOS 7 DIAS)</h5>
                                <div class="chart-container">
                                    <canvas id="graficoVendasLinha"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-4">
                                <h5 class="text-center mb-4">PRODUTOS MAIS VENDIDOS (QUANTIDADE)</h5>
                                <div class="chart-container">
                                    <canvas id="graficoRanking"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAIS -->
        <!-- Modal Cliente -->
        <div class="modal fade" id="modalCliente" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-light border-0">
                        <h5 class="modal-title" id="modalClienteTitle">NOVO CLIENTE</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="clienteId">
                        <div class="row">
                            <div class="col-md-6 mb-3"><label class="fw-semibold">NOME *</label><input type="text" id="modalClienteNome" class="form-control rounded-pill"></div>
                            <div class="col-md-6 mb-3"><label class="fw-semibold">ENDEREÇO</label><input type="text" id="modalClienteEndereco" class="form-control rounded-pill"></div>
                            <div class="col-md-4 mb-3"><label class="fw-semibold">CIDADE</label><input type="text" id="modalClienteCidade" class="form-control rounded-pill"></div>
                            <div class="col-md-4 mb-3"><label class="fw-semibold">ESTADO</label><input type="text" id="modalClienteEstado" class="form-control rounded-pill"></div>
                            <div class="col-md-4 mb-3"><label class="fw-semibold">CEP</label><input type="text" id="modalClienteCep" class="form-control rounded-pill"></div>
                            <div class="col-md-6 mb-3"><label class="fw-semibold">EMAIL</label><input type="email" id="modalClienteEmail" class="form-control rounded-pill"></div>
                            <div class="col-md-6 mb-3"><label class="fw-semibold">TELEFONE</label><input type="text" id="modalClienteTelefone" class="form-control rounded-pill"></div>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">CANCELAR</button>
                        <button class="btn btn-success rounded-pill px-4" onclick="salvarCliente()">SALVAR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Produto -->
        <div class="modal fade" id="modalProduto" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-light border-0">
                        <h5 class="modal-title" id="modalProdutoTitle">NOVO PRODUTO</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="produtoId">
                        <div class="mb-3"><label class="fw-semibold">NOME</label><input type="text" id="modalProdutoNome" class="form-control rounded-pill"></div>
                        <div class="mb-3"><label class="fw-semibold">CUSTO (R$)</label><input type="number" step="0.01" id="modalProdutoCusto" class="form-control rounded-pill"></div>
                        <div class="mb-3"><label class="fw-semibold">PREÇO (R$)</label><input type="number" step="0.01" id="modalProdutoPreco" class="form-control rounded-pill"></div>
                        <div class="mb-3"><label class="fw-semibold">ESTOQUE INICIAL</label><input type="number" id="modalProdutoEstoque" class="form-control rounded-pill"></div>
                    </div>
                    <div class="modal-footer border-0">
                        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">CANCELAR</button>
                        <button class="btn btn-success rounded-pill px-4" onclick="salvarProduto()">SALVAR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Gasto -->
        <div class="modal fade" id="modalGasto" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-light border-0">
                        <h5 class="modal-title" id="modalGastoTitle">NOVO GASTO</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="gastoId">
                        <input type="hidden" id="gastoTipo" value="entrada">
                        <div class="mb-3"><label class="fw-semibold">DATA</label><input type="date" id="gastoData" class="form-control rounded-pill"></div>
                        <div class="mb-3"><label class="fw-semibold">DESCRIÇÃO</label><input type="text" id="gastoDescricao" class="form-control rounded-pill"></div>
                        <div class="mb-3"><label class="fw-semibold">VALOR (R$)</label><input type="number" step="0.01" id="gastoValor" class="form-control rounded-pill"></div>
                    </div>
                    <div class="modal-footer border-0">
                        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">CANCELAR</button>
                        <button class="btn btn-success rounded-pill px-4" onclick="salvarGasto()">SALVAR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Negociar Crédito -->
        <div class="modal fade" id="modalNegociarCredito" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-warning text-white border-0">
                        <h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i>NEGOCIAR CRÉDITO</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="negociarCreditoId">
                        <p>CLIENTE: <strong id="negociarClienteNome"></strong></p>
                        <p>SALDO ATUAL: R$ <span id="negociarSaldoAtual"></span></p>
                        <hr>
                        <div class="mb-3">
                            <label class="fw-semibold">VALOR A PAGAR (OPCIONAL)</label>
                            <input type="number" id="negociarValorPago" class="form-control rounded-pill" step="0.01" min="0">
                        </div>
                        <div class="mb-3">
                            <label class="fw-semibold">NOVO NÚMERO DE PARCELAS (OPCIONAL)</label>
                            <select id="negociarNovasParcelas" class="form-select rounded-pill">
                                <option value="">SEM ALTERAÇÃO</option>
                                <option value="1">1X</option>
                                <option value="2">2X</option>
                                <option value="3">3X</option>
                                <option value="4">4X</option>
                                <option value="5">5X</option>
                                <option value="6">6X</option>
                            </select>
                        </div>
                        <small class="text-muted">SE INFORMAR VALOR, ELE SERÁ ABATIDO DO SALDO. SE INFORMAR PARCELAS, O RESTANTE SERÁ DIVIDIDO.</small>
                    </div>
                    <div class="modal-footer border-0">
                        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">CANCELAR</button>
                        <button class="btn btn-success rounded-pill px-4" onclick="confirmarNegociacao()">CONFIRMAR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Comprovante -->
        <div class="modal fade" id="modalComprovante" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content rounded-4">
                    <div class="modal-header bg-success text-white border-0">
                        <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>COMPROVANTE DE VENDA</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="comprovanteBody"></div>
                    <div class="modal-footer border-0">
                        <button class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">FECHAR</button>
                        <button class="btn btn-primary rounded-pill px-4" onclick="imprimirComprovante()"><i class="bi bi-printer me-2"></i>IMPRIMIR</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rodapé -->
        <footer class="footer text-center">
            <div class="container">
                <span class="opacity-75">MJ SOLUÇÕES - SISTEMA DE GESTÃO V6.0</span>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==================== FIREBASE CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyDtSMbTWT3EX4RAUJf3omVUbbsEl-U0PRU",
            authDomain: "mjsis-50e6c.firebaseapp.com",
            projectId: "mjsis-50e6c",
            storageBucket: "mjsis-50e6c.firebasestorage.app",
            messagingSenderId: "566986164188",
            appId: "1:566986164188:web:720d4a3237fc2bd7d17119"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==================== CONTROLE DE ACESSO ====================
        let usuarioLogado = { tipo: null }; // 'admin' ou 'user'

        function fazerLogin() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            if (user === 'miguelneto0x' && pass === '28061996') {
                usuarioLogado = { tipo: 'admin' };
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                document.getElementById('userInfo').innerText = 'ADMIN';
                iniciarSistema();
            } else if (user === 'meuacesso' && pass === '102050') {
                usuarioLogado = { tipo: 'user' };
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                document.getElementById('userInfo').innerText = 'USUÁRIO';
                iniciarSistema();
            } else {
                document.getElementById('loginError').innerText = 'USUÁRIO OU SENHA INVÁLIDOS';
            }
        }

        // ==================== VARIÁVEIS GLOBAIS ====================
        let itensVenda = [];
        let todosClientes = [];
        let todosProdutos = [];
        let todosCreditos = [];

        // ==================== UTILITÁRIOS ====================
        function formatarMoeda(valor) {
            return valor.toFixed(2).replace('.', ',');
        }

        // ==================== FUNÇÕES DE LEITURA ====================
        async function getClientes() {
            const snap = await db.collection('clientes').get();
            return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function getProdutos() {
            const snap = await db.collection('produtos').get();
            return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function getVendas() {
            const snap = await db.collection('vendas').get();
            return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function getGastos() {
            const snap = await db.collection('gastos').get();
            return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        async function getCreditos() {
            const snap = await db.collection('creditos').get();
            return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // ==================== CONTROLE DE BOTÕES POR PERFIL ====================
        function aplicarPermissoes() {
            if (usuarioLogado.tipo === 'user') {
                document.querySelectorAll('#btnNovoCliente, #btnNovoProduto, #btnNovaEntrada, #btnNovaSaida').forEach(btn => {
                    if (btn) btn.disabled = true;
                });
            } else {
                document.querySelectorAll('#btnNovoCliente, #btnNovoProduto, #btnNovaEntrada, #btnNovaSaida').forEach(btn => {
                    if (btn) btn.disabled = false;
                });
            }
        }

        // ==================== INICIALIZAÇÃO ====================
        async function iniciarSistema() {
            await carregarVenda();
            await renderClientes();
            await renderProdutos();
            await renderCreditos();
            await renderGastos();
            await carregarDashboard();
            aplicarPermissoes();

            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(btn => {
                btn.addEventListener('shown.bs.tab', async function(e) {
                    if (e.target.id === 'venda-tab') await carregarVenda();
                    if (e.target.id === 'clientes-tab') await renderClientes();
                    if (e.target.id === 'produtos-tab') await renderProdutos();
                    if (e.target.id === 'credito-tab') await renderCreditos();
                    if (e.target.id === 'gastos-tab') await renderGastos();
                    if (e.target.id === 'dashboard-tab') await carregarDashboard();
                });
            });
        }

        // ==================== ABA VENDA ====================
        async function carregarVenda() {
            itensVenda = [];
            atualizarListaItensVenda();
            document.getElementById('buscaProduto').value = '';
            document.getElementById('listaProdutosVenda').innerHTML = '';
            document.getElementById('formaPagamento').value = 'dinheiro';
            document.getElementById('valorRecebido').value = '';
            document.getElementById('trocoValor').innerText = '0,00';
            document.getElementById('entradaCredito').value = '';
            document.getElementById('parcelasCredito').value = '1';
            toggleFormaPagamento();
            await filtrarProdutosVenda();
            document.getElementById('buscaClienteVenda').value = '';
            document.getElementById('listaClientesVenda').innerHTML = '';
            document.getElementById('clienteIdVenda').value = '';
            document.getElementById('novoClienteVenda').style.display = 'none';
        }

        window.toggleFormaPagamento = function() {
            const forma = document.getElementById('formaPagamento').value;
            document.getElementById('trocoArea').style.display = forma === 'dinheiro' ? 'block' : 'none';
            document.getElementById('creditoArea').style.display = forma === 'credito' ? 'block' : 'none';
            if (forma !== 'dinheiro') {
                document.getElementById('valorRecebido').value = '';
                document.getElementById('trocoValor').innerText = '0,00';
            }
        };

        window.calcularTroco = function() {
            const total = parseFloat(document.getElementById('totalVenda').innerText.replace(',', '.')) || 0;
            const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
            const troco = recebido - total;
            document.getElementById('trocoValor').innerText = troco >= 0 ? formatarMoeda(troco) : '0,00';
        };

        window.buscarClientesVenda = async function() {
            const termo = document.getElementById('buscaClienteVenda').value.toLowerCase();
            const clientes = await getClientes();
            const lista = document.getElementById('listaClientesVenda');
            lista.innerHTML = '';
            if (termo.length < 2) return;
            const filtrados = clientes.filter(c => c.nome.toLowerCase().includes(termo));
            filtrados.forEach(c => {
                const div = document.createElement('div');
                div.className = 'produto-item';
                div.innerText = c.nome;
                div.onclick = () => {
                    document.getElementById('buscaClienteVenda').value = c.nome;
                    document.getElementById('clienteIdVenda').value = c.id;
                    lista.innerHTML = '';
                    document.getElementById('novoClienteVenda').style.display = 'none';
                };
                lista.appendChild(div);
            });
            if (filtrados.length === 0 && usuarioLogado.tipo === 'admin') {
                document.getElementById('novoClienteVenda').style.display = 'block';
            } else {
                document.getElementById('novoClienteVenda').style.display = 'none';
            }
        };

        window.filtrarProdutosVenda = async function() {
            const busca = document.getElementById('buscaProduto').value.toLowerCase();
            const produtos = await getProdutos();
            todosProdutos = produtos;
            const lista = document.getElementById('listaProdutosVenda');
            lista.innerHTML = '';
            produtos.filter(p => p.nome.toLowerCase().includes(busca) && p.estoque > 0).forEach(p => {
                const div = document.createElement('div');
                div.className = 'produto-item d-flex justify-content-between align-items-center';
                div.innerHTML = `<span><strong>${p.nome}</strong> - R$ ${p.preco.toFixed(2)} (ESTOQUE: ${p.estoque})</span>
                                 <button class="btn btn-sm btn-success rounded-pill" onclick="adicionarItemVenda('${p.id}', '${p.nome}', ${p.preco}, ${p.custo}, ${p.estoque})"><i class="bi bi-plus"></i></button>`;
                lista.appendChild(div);
            });
        };

        window.adicionarItemVenda = function(id, nome, preco, custo, estoque) {
            const existente = itensVenda.find(i => i.produtoId === id);
            if (existente) {
                if (existente.quantidade + 1 > estoque) {
                    alert('QUANTIDADE EXCEDE O ESTOQUE!');
                    return;
                }
                existente.quantidade++;
                existente.subtotal = existente.quantidade * preco;
            } else {
                if (1 > estoque) {
                    alert('PRODUTO SEM ESTOQUE!');
                    return;
                }
                itensVenda.push({
                    produtoId: id,
                    nome: nome,
                    quantidade: 1,
                    preco: preco,
                    custo: custo,
                    subtotal: preco
                });
            }
            atualizarListaItensVenda();
        };

        window.alterarQuantidadeItem = function(index, novaQtd, estoque) {
            if (novaQtd < 1) {
                itensVenda.splice(index, 1);
            } else {
                const item = itensVenda[index];
                if (novaQtd > estoque) {
                    alert('QUANTIDADE SUPERIOR AO ESTOQUE!');
                    return;
                }
                item.quantidade = novaQtd;
                item.subtotal = novaQtd * item.preco;
            }
            atualizarListaItensVenda();
        };

        window.removerItemVenda = function(index) {
            itensVenda.splice(index, 1);
            atualizarListaItensVenda();
        };

        function atualizarListaItensVenda() {
            const container = document.getElementById('itensVendaContainer');
            container.innerHTML = '';
            let total = 0;
            itensVenda.forEach((item, idx) => {
                total += item.subtotal;
                const div = document.createElement('div');
                div.className = 'item-venda';
                div.innerHTML = `
                    <span><strong>${item.nome}</strong> R$ ${item.preco.toFixed(2)} x 
                        <input type="number" min="1" value="${item.quantidade}" style="width:70px; border-radius:50px; border:1px solid #ddd; padding:5px;" onchange="alterarQuantidadeItem(${idx}, parseInt(this.value), ${item.estoque})">
                    = R$ ${item.subtotal.toFixed(2)}</span>
                    <i class="bi bi-trash text-danger fs-5" style="cursor:pointer;" onclick="removerItemVenda(${idx})"></i>
                `;
                container.appendChild(div);
            });
            document.getElementById('totalVenda').innerText = total.toFixed(2).replace('.', ',');
            if (document.getElementById('formaPagamento').value === 'dinheiro') calcularTroco();
        }

        window.finalizarVenda = async function() {
            if (itensVenda.length === 0) {
                document.getElementById('vendaMsg').innerHTML = '<div class="alert alert-warning rounded-pill">ADICIONE ITENS À VENDA.</div>';
                return;
            }
            let clienteId = document.getElementById('clienteIdVenda').value;
            const novoNome = document.getElementById('novoClienteNome').value.trim();
            if (!clienteId && !novoNome) {
                document.getElementById('vendaMsg').innerHTML = '<div class="alert alert-warning rounded-pill">SELECIONE OU CADASTRE UM CLIENTE.</div>';
                return;
            }
            let clienteNome = '';
            if (!clienteId && novoNome) {
                if (usuarioLogado.tipo !== 'admin') {
                    document.getElementById('vendaMsg').innerHTML = '<div class="alert alert-danger rounded-pill">APENAS ADMINISTRADORES PODEM CADASTRAR NOVOS CLIENTES.</div>';
                    return;
                }
                const clientes = await getClientes();
                const novoCliente = {
                    nome: novoNome,
                    endereco: document.getElementById('novoClienteEndereco').value.trim(),
                    cidade: document.getElementById('novoClienteCidade').value.trim(),
                    estado: document.getElementById('novoClienteEstado').value.trim(),
                    cep: document.getElementById('novoClienteCep').value.trim(),
                    email: document.getElementById('novoClienteEmail').value.trim(),
                    telefone: document.getElementById('novoClienteTelefone').value.trim()
                };
                const docRef = await db.collection('clientes').add(novoCliente);
                clienteId = docRef.id;
                clienteNome = novoNome;
            } else if (clienteId) {
                const clienteDoc = await db.collection('clientes').doc(clienteId).get();
                clienteNome = clienteDoc.data().nome;
            }

            const produtos = await getProdutos();
            for (let item of itensVenda) {
                const prod = produtos.find(p => p.id === item.produtoId);
                if (!prod || prod.estoque < item.quantidade) {
                    document.getElementById('vendaMsg').innerHTML = `<div class="alert alert-danger rounded-pill">ESTOQUE INSUFICIENTE PARA ${item.nome}.</div>`;
                    return;
                }
            }

            const forma = document.getElementById('formaPagamento').value;
            const total = itensVenda.reduce((acc, i) => acc + i.subtotal, 0);

            if (forma === 'credito') {
                const entrada = parseFloat(document.getElementById('entradaCredito').value) || 0;
                const parcelas = parseInt(document.getElementById('parcelasCredito').value);
                const valorFinanciado = total - entrada;
                const valorParcela = valorFinanciado / parcelas;

                const credito = {
                    clienteId: clienteId,
                    clienteNome: clienteNome,
                    data: new Date().toISOString().split('T')[0],
                    total: total,
                    entrada: entrada,
                    parcelas: parcelas,
                    valorParcela: valorParcela,
                    parcelasPagas: 0,
                    quitado: false
                };
                await db.collection('creditos').add(credito);
            } else {
                const recebido = forma === 'dinheiro' ? parseFloat(document.getElementById('valorRecebido').value) || 0 : total;
                if (forma === 'dinheiro' && recebido < total) {
                    document.getElementById('vendaMsg').innerHTML = '<div class="alert alert-danger rounded-pill">VALOR RECEBIDO INSUFICIENTE.</div>';
                    return;
                }

                const venda = {
                    data: new Date().toISOString().split('T')[0],
                    hora: new Date().toLocaleTimeString(),
                    clienteId: clienteId,
                    clienteNome: clienteNome,
                    formaPagamento: forma,
                    total: total,
                    itens: itensVenda.map(i => ({
                        produtoId: i.produtoId,
                        nome: i.nome,
                        quantidade: i.quantidade,
                        preco: i.preco,
                        custo: i.custo,
                        subtotal: i.subtotal
                    }))
                };
                await db.collection('vendas').add(venda);

                for (let item of itensVenda) {
                    const prod = produtos.find(p => p.id === item.produtoId);
                    prod.estoque -= item.quantidade;
                    await db.collection('produtos').doc(item.produtoId).update({ estoque: prod.estoque });
                }
            }

            exibirComprovante({ total, clienteNome, forma, itens: itensVenda });

            itensVenda = [];
            atualizarListaItensVenda();
            document.getElementById('vendaMsg').innerHTML = '<div class="alert alert-success rounded-pill">VENDA FINALIZADA!</div>';
            document.getElementById('valorRecebido').value = '';
            document.getElementById('trocoValor').innerText = '0,00';
            document.getElementById('entradaCredito').value = '';
            await carregarVenda();
        };

        function exibirComprovante(venda) {
            let html = `
                <div style="font-family: 'Courier New', monospace; padding: 20px;">
                    <h4 class="text-center">COMPROVANTE DE COMPRA</h4>
                    <p><strong>RAZÃO SOCIAL:</strong> MJ SOLUÇÕES</p>
                    <p><strong>EMAIL:</strong> MIGUELNETOMKT@GMAIL.COM</p>
                    <p><strong>WHATSAPP:</strong> <a href="https://w.app/t5dzhj" target="_blank">HTTPS://W.APP/T5DZHJ</a></p>
                    <hr>
                    <p><strong>CLIENTE:</strong> ${venda.clienteNome}</p>
                    <table style="width:100%; border-collapse: collapse;">
                        <thead><tr><th>PRODUTO</th><th>QTD</th><th>VALOR UNIT.</th><th>VALOR TOTAL</th></tr></thead>
                        <tbody>
            `;
            venda.itens.forEach(i => {
                html += `<tr><td>${i.nome}</td><td>${i.quantidade}</td><td>R$ ${i.preco.toFixed(2)}</td><td>R$ ${i.subtotal.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table>`;
            html += `<p><strong>DATA DA COMPRA:</strong> ${new Date().toLocaleString()}</p>`;
            html += `<p><strong>FORMA DE PAGAMENTO:</strong> ${venda.forma.toUpperCase()}</p>`;
            if (venda.forma === 'dinheiro') {
                const recebido = parseFloat(document.getElementById('valorRecebido').value) || 0;
                const troco = recebido - venda.total;
                html += `<p><strong>VALOR RECEBIDO:</strong> R$ ${recebido.toFixed(2)}</p>`;
                html += `<p><strong>TROCO:</strong> R$ ${troco.toFixed(2)}</p>`;
            }
            html += `<hr><p class="text-center">AGRADECEMOS A PREFERÊNCIA!<br>ESTE É UM COMPROVANTE NÃO FISCAL.</p>`;
            html += `<h5 class="text-center">MJ SOLUÇÕES®</h5></div>`;
            document.getElementById('comprovanteBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('modalComprovante')).show();
        }

        window.imprimirComprovante = function() {
            const conteudo = document.getElementById('comprovanteBody').innerHTML;
            const win = window.open('', '_blank');
            win.document.write('<html><head><title>COMPROVANTE</title>');
            win.document.write('<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">');
            win.document.write('</head><body class="p-4">' + conteudo + '</body></html>');
            win.document.close();
            win.print();
        };

        // ==================== CLIENTES CRUD ====================
        async function renderClientes() {
            const clientes = await getClientes();
            todosClientes = clientes;
            filtrarClientes();
        }

        window.filtrarClientes = function() {
            const termo = document.getElementById('buscaClientes').value.toLowerCase();
            const filtrados = todosClientes.filter(c => 
                c.nome.toLowerCase().includes(termo) || 
                (c.email && c.email.toLowerCase().includes(termo)) ||
                (c.telefone && c.telefone.includes(termo))
            );
            const tbody = document.querySelector('#tabelaClientes tbody');
            tbody.innerHTML = '';
            filtrados.forEach(c => {
                const acoes = usuarioLogado.tipo === 'admin' 
                    ? `<button class="btn btn-sm btn-outline-success rounded-pill me-2" onclick="editarCliente('${c.id}')"><i class="bi bi-pencil"></i></button>
                       <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="excluirCliente('${c.id}')"><i class="bi bi-trash"></i></button>`
                    : '<span class="text-muted">APENAS VISUALIZAÇÃO</span>';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.id.substring(0,6)}...</td>
                    <td>${c.nome}</td>
                    <td>${c.cidade || ''}, ${c.estado || ''}</td>
                    <td>${c.telefone || ''}</td>
                    <td>${c.email || ''}</td>
                    <td>${acoes}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.limparModalCliente = function() {
            if (usuarioLogado.tipo !== 'admin') return;
            document.getElementById('clienteId').value = '';
            document.getElementById('modalClienteNome').value = '';
            document.getElementById('modalClienteEndereco').value = '';
            document.getElementById('modalClienteCidade').value = '';
            document.getElementById('modalClienteEstado').value = '';
            document.getElementById('modalClienteCep').value = '';
            document.getElementById('modalClienteEmail').value = '';
            document.getElementById('modalClienteTelefone').value = '';
            document.getElementById('modalClienteTitle').innerText = 'NOVO CLIENTE';
        };

        window.editarCliente = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            const doc = await db.collection('clientes').doc(id).get();
            const c = doc.data();
            document.getElementById('clienteId').value = id;
            document.getElementById('modalClienteNome').value = c.nome || '';
            document.getElementById('modalClienteEndereco').value = c.endereco || '';
            document.getElementById('modalClienteCidade').value = c.cidade || '';
            document.getElementById('modalClienteEstado').value = c.estado || '';
            document.getElementById('modalClienteCep').value = c.cep || '';
            document.getElementById('modalClienteEmail').value = c.email || '';
            document.getElementById('modalClienteTelefone').value = c.telefone || '';
            document.getElementById('modalClienteTitle').innerText = 'EDITAR CLIENTE';
            new bootstrap.Modal(document.getElementById('modalCliente')).show();
        };

        window.salvarCliente = async function() {
            if (usuarioLogado.tipo !== 'admin') return;
            const id = document.getElementById('clienteId').value;
            const dados = {
                nome: document.getElementById('modalClienteNome').value.trim(),
                endereco: document.getElementById('modalClienteEndereco').value.trim(),
                cidade: document.getElementById('modalClienteCidade').value.trim(),
                estado: document.getElementById('modalClienteEstado').value.trim(),
                cep: document.getElementById('modalClienteCep').value.trim(),
                email: document.getElementById('modalClienteEmail').value.trim(),
                telefone: document.getElementById('modalClienteTelefone').value.trim()
            };
            if (!dados.nome) return alert('NOME É OBRIGATÓRIO.');
            if (id) await db.collection('clientes').doc(id).update(dados);
            else await db.collection('clientes').add(dados);
            await renderClientes();
            bootstrap.Modal.getInstance(document.getElementById('modalCliente')).hide();
        };

        window.excluirCliente = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            if (confirm('EXCLUIR CLIENTE?')) {
                await db.collection('clientes').doc(id).delete();
                await renderClientes();
            }
        };

        // ==================== PRODUTOS CRUD ====================
        async function renderProdutos() {
            const produtos = await getProdutos();
            todosProdutos = produtos;
            filtrarProdutos();
        }

        window.filtrarProdutos = function() {
            const termo = document.getElementById('buscaProdutos').value.toLowerCase();
            const filtrados = todosProdutos.filter(p => p.nome.toLowerCase().includes(termo));
            const tbody = document.querySelector('#tabelaProdutos tbody');
            tbody.innerHTML = '';
            filtrados.forEach(p => {
                const margem = p.custo > 0 ? ((p.preco - p.custo) / p.custo * 100).toFixed(2) : 0;
                const acoes = usuarioLogado.tipo === 'admin'
                    ? `<button class="btn btn-sm btn-outline-success rounded-pill me-2" onclick="editarProduto('${p.id}')"><i class="bi bi-pencil"></i></button>
                       <button class="btn btn-sm btn-outline-danger rounded-pill" onclick="excluirProduto('${p.id}')"><i class="bi bi-trash"></i></button>`
                    : '<span class="text-muted">APENAS VISUALIZAÇÃO</span>';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.id.substring(0,6)}...</td>
                    <td>${p.nome}</td>
                    <td>R$ ${p.custo.toFixed(2)}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td>${p.estoque}</td>
                    <td>${margem}%</td>
                    <td>${acoes}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.limparModalProduto = function() {
            if (usuarioLogado.tipo !== 'admin') return;
            document.getElementById('produtoId').value = '';
            document.getElementById('modalProdutoNome').value = '';
            document.getElementById('modalProdutoCusto').value = '';
            document.getElementById('modalProdutoPreco').value = '';
            document.getElementById('modalProdutoEstoque').value = '';
            document.getElementById('modalProdutoTitle').innerText = 'NOVO PRODUTO';
        };

        window.editarProduto = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            const doc = await db.collection('produtos').doc(id).get();
            const p = doc.data();
            document.getElementById('produtoId').value = id;
            document.getElementById('modalProdutoNome').value = p.nome || '';
            document.getElementById('modalProdutoCusto').value = p.custo || '';
            document.getElementById('modalProdutoPreco').value = p.preco || '';
            document.getElementById('modalProdutoEstoque').value = p.estoque || '';
            document.getElementById('modalProdutoTitle').innerText = 'EDITAR PRODUTO';
            new bootstrap.Modal(document.getElementById('modalProduto')).show();
        };

        window.salvarProduto = async function() {
            if (usuarioLogado.tipo !== 'admin') return;
            const id = document.getElementById('produtoId').value;
            const dados = {
                nome: document.getElementById('modalProdutoNome').value.trim(),
                custo: parseFloat(document.getElementById('modalProdutoCusto').value),
                preco: parseFloat(document.getElementById('modalProdutoPreco').value),
                estoque: parseInt(document.getElementById('modalProdutoEstoque').value)
            };
            if (!dados.nome || isNaN(dados.custo) || isNaN(dados.preco) || isNaN(dados.estoque)) {
                return alert('PREENCHA TODOS OS CAMPOS CORRETAMENTE.');
            }
            if (id) await db.collection('produtos').doc(id).update(dados);
            else await db.collection('produtos').add(dados);
            await renderProdutos();
            bootstrap.Modal.getInstance(document.getElementById('modalProduto')).hide();
        };

        window.excluirProduto = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            if (confirm('EXCLUIR PRODUTO?')) {
                await db.collection('produtos').doc(id).delete();
                await renderProdutos();
            }
        };

        // ==================== CRÉDITO DA LOJA ====================
        async function renderCreditos() {
            const creditos = await getCreditos();
            todosCreditos = creditos;
            filtrarCreditos();
            // Totais
            const totalReceber = creditos.filter(c => !c.quitado).reduce((acc, c) => acc + (c.total - c.entrada - (c.valorParcela * c.parcelasPagas)), 0);
            const totalClientes = new Set(creditos.filter(c => !c.quitado).map(c => c.clienteId)).size;
            document.getElementById('totalCredito').innerText = formatarMoeda(totalReceber);
            document.getElementById('totalClientesDebito').innerText = totalClientes;
        }

        window.filtrarCreditos = function() {
            const termo = document.getElementById('buscaCredito').value.toLowerCase();
            const filtrados = todosCreditos.filter(c => c.clienteNome.toLowerCase().includes(termo));
            const tbody = document.querySelector('#tabelaCredito tbody');
            tbody.innerHTML = '';
            filtrados.forEach(c => {
                const saldo = c.total - c.entrada - (c.valorParcela * c.parcelasPagas);
                const status = c.quitado ? 'QUITADO' : 'PENDENTE';
                const statusClass = c.quitado ? 'badge-quitado' : 'badge-pendente';
                const acoes = usuarioLogado.tipo === 'admin' && !c.quitado
                    ? `<button class="btn btn-sm btn-outline-success rounded-pill me-2" onclick="registrarPagamento('${c.id}')"><i class="bi bi-cash me-1"></i>PAGAR</button>
                       <button class="btn btn-sm btn-outline-warning rounded-pill" onclick="negociarCredito('${c.id}')"><i class="bi bi-arrow-repeat me-1"></i>NEGOCIAR</button>`
                    : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.clienteNome}</td>
                    <td>R$ ${c.total.toFixed(2)}</td>
                    <td>R$ ${c.entrada.toFixed(2)}</td>
                    <td>${c.parcelas}X</td>
                    <td>R$ ${c.valorParcela.toFixed(2)}</td>
                    <td>${c.parcelasPagas}</td>
                    <td>R$ ${saldo.toFixed(2)}</td>
                    <td><span class="badge ${statusClass}">${status}</span></td>
                    <td>${acoes}</td>
                `;
                tbody.appendChild(tr);
            });
        };

        window.registrarPagamento = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            const creditoRef = db.collection('creditos').doc(id);
            const doc = await creditoRef.get();
            const c = doc.data();
            if (c.quitado) {
                alert('ESTE CRÉDITO JÁ ESTÁ QUITADO.');
                return;
            }
            const novasParcelasPagas = c.parcelasPagas + 1;
            const quitado = novasParcelasPagas >= c.parcelas;
            await creditoRef.update({
                parcelasPagas: novasParcelasPagas,
                quitado: quitado
            });
            await renderCreditos();
        };

        window.negociarCredito = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            const doc = await db.collection('creditos').doc(id).get();
            const c = doc.data();
            const saldo = c.total - c.entrada - (c.valorParcela * c.parcelasPagas);
            document.getElementById('negociarCreditoId').value = id;
            document.getElementById('negociarClienteNome').innerText = c.clienteNome;
            document.getElementById('negociarSaldoAtual').innerText = saldo.toFixed(2);
            document.getElementById('negociarValorPago').value = '';
            document.getElementById('negociarNovasParcelas').value = '';
            new bootstrap.Modal(document.getElementById('modalNegociarCredito')).show();
        };

        window.confirmarNegociacao = async function() {
            const id = document.getElementById('negociarCreditoId').value;
            const valorPago = parseFloat(document.getElementById('negociarValorPago').value) || 0;
            const novasParcelas = document.getElementById('negociarNovasParcelas').value;

            const creditoRef = db.collection('creditos').doc(id);
            const doc = await creditoRef.get();
            const c = doc.data();
            let saldoAtual = c.total - c.entrada - (c.valorParcela * c.parcelasPagas);

            if (valorPago > saldoAtual) {
                alert('VALOR PAGO NÃO PODE SER MAIOR QUE O SALDO.');
                return;
            }

            let novoSaldo = saldoAtual - valorPago;
            let novasParcelasNum = novasParcelas ? parseInt(novasParcelas) : c.parcelas - c.parcelasPagas;
            if (novasParcelasNum <= 0) novasParcelasNum = 1;

            const novoValorParcela = novoSaldo / novasParcelasNum;
            const novaEntrada = c.entrada + valorPago;
            const novasParcelasPagas = 0; // reinicia a contagem de parcelas pagas para o novo plano

            await creditoRef.update({
                entrada: novaEntrada,
                parcelas: novasParcelasNum,
                valorParcela: novoValorParcela,
                parcelasPagas: 0,
                quitado: false
            });

            bootstrap.Modal.getInstance(document.getElementById('modalNegociarCredito')).hide();
            await renderCreditos();
        };

        // ==================== GASTOS ====================
        window.limparModalGasto = function(tipo) {
            if (usuarioLogado.tipo !== 'admin') return;
            document.getElementById('gastoId').value = '';
            document.getElementById('gastoTipo').value = tipo;
            document.getElementById('gastoData').value = new Date().toISOString().split('T')[0];
            document.getElementById('gastoDescricao').value = '';
            document.getElementById('gastoValor').value = '';
            document.getElementById('modalGastoTitle').innerText = tipo === 'entrada' ? 'NOVA ENTRADA' : 'NOVA SAÍDA';
        };

        window.salvarGasto = async function() {
            if (usuarioLogado.tipo !== 'admin') return;
            const id = document.getElementById('gastoId').value;
            const dados = {
                tipo: document.getElementById('gastoTipo').value,
                data: document.getElementById('gastoData').value,
                descricao: document.getElementById('gastoDescricao').value.trim(),
                valor: parseFloat(document.getElementById('gastoValor').value)
            };
            if (!dados.data || !dados.descricao || isNaN(dados.valor)) return alert('PREENC HA TODOS OS CAMPOS.');
            if (id) await db.collection('gastos').doc(id).update(dados);
            else await db.collection('gastos').add(dados);
            await renderGastos();
            bootstrap.Modal.getInstance(document.getElementById('modalGasto')).hide();
        };

        async function renderGastos() {
            const gastos = await getGastos();
            const entradas = gastos.filter(g => g.tipo === 'entrada').sort((a,b) => b.data.localeCompare(a.data));
            const saidas = gastos.filter(g => g.tipo === 'saida').sort((a,b) => b.data.localeCompare(a.data));

            let htmlEnt = '<ul class="list-group list-group-flush">';
            entradas.slice(0,10).forEach(g => {
                htmlEnt += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${g.data} - ${g.descricao} 
                    <span>
                        <span class="badge bg-success rounded-pill me-2">R$ ${g.valor.toFixed(2)}</span>
                        ${usuarioLogado.tipo === 'admin' ? `
                            <i class="bi bi-pencil text-primary me-2" style="cursor:pointer;" onclick="editarGasto('${g.id}')"></i>
                            <i class="bi bi-trash text-danger" style="cursor:pointer;" onclick="excluirGasto('${g.id}')"></i>
                        ` : ''}
                    </span>
                </li>`;
            });
            htmlEnt += '</ul>';
            document.getElementById('listaEntradas').innerHTML = htmlEnt;

            let htmlSai = '<ul class="list-group list-group-flush">';
            saidas.slice(0,10).forEach(g => {
                htmlSai += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${g.data} - ${g.descricao} 
                    <span>
                        <span class="badge bg-danger rounded-pill me-2">R$ ${g.valor.toFixed(2)}</span>
                        ${usuarioLogado.tipo === 'admin' ? `
                            <i class="bi bi-pencil text-primary me-2" style="cursor:pointer;" onclick="editarGasto('${g.id}')"></i>
                            <i class="bi bi-trash text-danger" style="cursor:pointer;" onclick="excluirGasto('${g.id}')"></i>
                        ` : ''}
                    </span>
                </li>`;
            });
            htmlSai += '</ul>';
            document.getElementById('listaSaidas').innerHTML = htmlSai;
        }

        window.editarGasto = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            const doc = await db.collection('gastos').doc(id).get();
            const g = doc.data();
            document.getElementById('gastoId').value = id;
            document.getElementById('gastoTipo').value = g.tipo;
            document.getElementById('gastoData').value = g.data;
            document.getElementById('gastoDescricao').value = g.descricao;
            document.getElementById('gastoValor').value = g.valor;
            document.getElementById('modalGastoTitle').innerText = g.tipo === 'entrada' ? 'EDITAR ENTRADA' : 'EDITAR SAÍDA';
            new bootstrap.Modal(document.getElementById('modalGasto')).show();
        };

        window.excluirGasto = async function(id) {
            if (usuarioLogado.tipo !== 'admin') return;
            if (confirm('EXCLUIR GASTO?')) {
                await db.collection('gastos').doc(id).delete();
                await renderGastos();
            }
        };

        // ==================== RELATÓRIOS ====================
        window.gerarRelatorio = async function() {
            const tipo = document.getElementById('relTipo').value;
            const inicio = document.getElementById('relInicio').value;
            const fim = document.getElementById('relFim').value;

            if (!inicio || !fim && tipo !== 'estoque' && tipo !== 'credito') return alert('SELECIONE O PERÍODO.');

            let html = `<h5 class="mb-3">PERÍODO: ${inicio || 'TODOS'} A ${fim || 'TODOS'} | TIPO: ${tipo}</h5>`;

            if (tipo === 'vendas') {
                const vendas = await getVendas();
                const clientes = await getClientes();
                let filtradas = vendas.filter(v => v.data >= inicio && v.data <= fim);
                filtradas.sort((a,b) => a.data.localeCompare(b.data));
                const totalVendas = filtradas.reduce((acc, v) => acc + v.total, 0);
                const totalCusto = filtradas.reduce((acc, v) => acc + v.itens.reduce((sub, i) => sub + i.custo * i.quantidade, 0), 0);
                const lucro = totalVendas - totalCusto;
                const margem = totalVendas > 0 ? (lucro / totalVendas) * 100 : 0;
                html += `<div class="row g-2 mb-3">
                    <div class="col-md-3"><div class="card bg-light p-2"><h6>TOTAL VENDAS</h6><h5 class="text-success">R$ ${formatarMoeda(totalVendas)}</h5></div></div>
                    <div class="col-md-3"><div class="card bg-light p-2"><h6>CUSTO TOTAL</h6><h5 class="text-danger">R$ ${formatarMoeda(totalCusto)}</h5></div></div>
                    <div class="col-md-3"><div class="card bg-light p-2"><h6>LUCRO</h6><h5 class="text-primary">R$ ${formatarMoeda(lucro)}</h5></div></div>
                    <div class="col-md-3"><div class="card bg-light p-2"><h6>MARGEM</h6><h5>${margem.toFixed(2).replace('.',',')}%</h5></div></div>
                </div>`;
                html += `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>DATA</th><th>CLIENTE</th><th>PAGAMENTO</th><th>TOTAL</th></tr></thead><tbody>`;
                filtradas.forEach(v => {
                    const cliente = clientes.find(c => c.id === v.clienteId) || { nome: 'DESCONHECIDO' };
                    html += `<tr><td>${v.data}</td><td>${cliente.nome}</td><td>${v.formaPagamento}</td><td>R$ ${v.total.toFixed(2)}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            } else if (tipo === 'estoque') {
                const produtos = await getProdutos();
                html += `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>PRODUTO</th><th>CUSTO</th><th>PREÇO</th><th>ESTOQUE</th><th>VALOR CUSTO</th><th>VALOR VENDA</th><th>MARGEM</th></tr></thead><tbody>`;
                produtos.forEach(p => {
                    const valorCusto = p.custo * p.estoque;
                    const valorVenda = p.preco * p.estoque;
                    const margem = p.custo > 0 ? ((p.preco - p.custo) / p.custo * 100).toFixed(2) : 0;
                    html += `<tr><td>${p.nome}</td><td>R$ ${p.custo.toFixed(2)}</td><td>R$ ${p.preco.toFixed(2)}</td><td>${p.estoque}</td><td>R$ ${valorCusto.toFixed(2)}</td><td>R$ ${valorVenda.toFixed(2)}</td><td>${margem}%</td></tr>`;
                });
                html += `</tbody></table></div>`;
            } else if (tipo === 'entradas') {
                const gastos = await getGastos();
                let filtrados = gastos.filter(g => g.tipo === 'entrada' && g.data >= inicio && g.data <= fim);
                filtrados.sort((a,b) => a.data.localeCompare(b.data));
                const total = filtrados.reduce((acc, g) => acc + g.valor, 0);
                html += `<div class="alert alert-success">TOTAL DE ENTRADAS: R$ ${formatarMoeda(total)}</div>`;
                html += `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>DATA</th><th>DESCRIÇÃO</th><th>VALOR</th></tr></thead><tbody>`;
                filtrados.forEach(g => html += `<tr><td>${g.data}</td><td>${g.descricao}</td><td>R$ ${g.valor.toFixed(2)}</td></tr>`);
                html += `</tbody></table></div>`;
            } else if (tipo === 'saidas') {
                const gastos = await getGastos();
                let filtrados = gastos.filter(g => g.tipo === 'saida' && g.data >= inicio && g.data <= fim);
                filtrados.sort((a,b) => a.data.localeCompare(b.data));
                const total = filtrados.reduce((acc, g) => acc + g.valor, 0);
                html += `<div class="alert alert-danger">TOTAL DE SAÍDAS: R$ ${formatarMoeda(total)}</div>`;
                html += `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>DATA</th><th>DESCRIÇÃO</th><th>VALOR</th></tr></thead><tbody>`;
                filtrados.forEach(g => html += `<tr><td>${g.data}</td><td>${g.descricao}</td><td>R$ ${g.valor.toFixed(2)}</td></tr>`);
                html += `</tbody></table></div>`;
            } else if (tipo === 'credito') {
                const creditos = await getCreditos();
                const totalDevido = creditos.filter(c => !c.quitado).reduce((acc, c) => acc + (c.total - c.entrada - (c.valorParcela * c.parcelasPagas)), 0);
                html += `<div class="alert alert-warning">TOTAL A RECEBER: R$ ${formatarMoeda(totalDevido)}</div>`;
                html += `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>CLIENTE</th><th>TOTAL</th><th>ENTRADA</th><th>PARCELAS</th><th>PARCELAS PAGAS</th><th>SALDO</th><th>STATUS</th></tr></thead><tbody>`;
                creditos.forEach(c => {
                    const saldo = c.total - c.entrada - (c.valorParcela * c.parcelasPagas);
                    const status = c.quitado ? 'QUITADO' : 'PENDENTE';
                    html += `<tr><td>${c.clienteNome}</td><td>R$ ${c.total.toFixed(2)}</td><td>R$ ${c.entrada.toFixed(2)}</td><td>${c.parcelas}X</td><td>${c.parcelasPagas}</td><td>R$ ${saldo.toFixed(2)}</td><td>${status}</td></tr>`;
                });
                html += `</tbody></table></div>`;
            }
            document.getElementById('relatorioResultado').innerHTML = html;
        };

        window.verItensVenda = async function(vendaId) {
            const vendas = await getVendas();
            const v = vendas.find(v => v.id === vendaId);
            if (!v) return;
            let html = '<table class="table"><tr><th>PRODUTO</th><th>QTD</th><th>PREÇO</th><th>SUBTOTAL</th></tr>';
            v.itens.forEach(i => {
                html += `<tr><td>${i.nome}</td><td>${i.quantidade}</td><td>R$ ${i.preco.toFixed(2)}</td><td>R$ ${i.subtotal.toFixed(2)}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('comprovanteBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('modalComprovante')).show();
        };

        // ==================== EXPORTAÇÕES ====================
        window.exportarPDF = async function() {
            const tipo = document.getElementById('relTipo').value;
            const inicio = document.getElementById('relInicio').value;
            const fim = document.getElementById('relFim').value;
            const conteudo = document.getElementById('relatorioResultado').innerHTML;
            if (!conteudo.trim()) {
                alert('GERE UM RELATÓRIO PRIMEIRO.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`RELATÓRIO: ${tipo.toUpperCase()}`, 14, 20);
            doc.text(`PERÍODO: ${inicio || 'TODOS'} A ${fim || 'TODOS'}`, 14, 30);
            
            // Extrair tabela do HTML
            const tabela = document.querySelector('#relatorioResultado table');
            if (tabela) {
                const headers = [];
                const rows = [];
                tabela.querySelectorAll('thead tr th').forEach(th => headers.push(th.innerText));
                tabela.querySelectorAll('tbody tr').forEach(tr => {
                    const row = [];
                    tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
                    rows.push(row);
                });
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 40,
                    styles: { fontSize: 8 }
                });
            } else {
                doc.text('RELATÓRIO SEM TABELA.', 14, 40);
            }
            doc.save(`relatorio_${tipo}_${inicio || 'todos'}_${fim || 'todos'}.pdf`);
        };

        window.exportarExcel = async function() {
            const tipo = document.getElementById('relTipo').value;
            const inicio = document.getElementById('relInicio').value;
            const fim = document.getElementById('relFim').value;
            const tabela = document.querySelector('#relatorioResultado table');
            if (!tabela) {
                alert('NENHUMA TABELA PARA EXPORTAR.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.table_to_sheet(tabela);
            XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
            XLSX.writeFile(wb, `relatorio_${tipo}_${inicio || 'todos'}_${fim || 'todos'}.xlsx`);
        };

        // ==================== FECHAMENTO MENSAL ====================
        window.fecharMes = async function() {
            if (usuarioLogado.tipo !== 'admin') {
                alert('APENAS ADMINISTRADOR PODE FECHAR O MÊS.');
                return;
            }
            if (!confirm('ISSO IRÁ GERAR UM PDF COM OS DADOS DO MÊS ATUAL E EXCLUIR TODAS AS VENDAS E GASTOS DESTE MÊS. OS CRÉDITOS SERÃO MANTIDOS. DESEJA CONTINUAR?')) return;

            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const inicio = `${ano}-${mes}-01`;
            const fim = `${ano}-${mes}-31`; // pega todo o mês

            // Gerar relatório em PDF
            document.getElementById('relInicio').value = inicio;
            document.getElementById('relFim').value = fim;
            document.getElementById('relTipo').value = 'vendas';
            await gerarRelatorio();
            await exportarPDF(); // salva PDF

            // Agora excluir vendas e gastos do mês
            const vendas = await getVendas();
            const vendasMes = vendas.filter(v => v.data >= inicio && v.data <= fim);
            for (let v of vendasMes) {
                await db.collection('vendas').doc(v.id).delete();
            }

            const gastos = await getGastos();
            const gastosMes = gastos.filter(g => g.data >= inicio && g.data <= fim);
            for (let g of gastosMes) {
                await db.collection('gastos').doc(g.id).delete();
            }

            alert('MÊS FECHADO! VENDAS E GASTOS DO MÊS FORAM EXCLUÍDOS.');
            await renderGastos();
            await carregarDashboard();
        };

        // ==================== DASHBOARD ====================
        async function carregarDashboard() {
            const vendas = await getVendas();
            const produtos = await getProdutos();
            const hoje = new Date();
            const mesAtual = hoje.toISOString().slice(0,7);

            const vendasMes = vendas.filter(v => v.data.startsWith(mesAtual));
            const totalVendasMes = vendasMes.reduce((acc, v) => acc + v.total, 0);
            const totalCustoMes = vendasMes.reduce((acc, v) => acc + v.itens.reduce((sub, i) => sub + i.custo * i.quantidade, 0), 0);
            const lucroMes = totalVendasMes - totalCustoMes;
            const totalEstoqueItens = produtos.reduce((acc, p) => acc + p.estoque, 0);

            document.getElementById('totalVendasMes').innerText = formatarMoeda(totalVendasMes);
            document.getElementById('totalCustoMes').innerText = formatarMoeda(totalCustoMes);
            document.getElementById('totalLucroMes').innerText = formatarMoeda(lucroMes);
            document.getElementById('totalEstoqueItens').innerText = totalEstoqueItens;

            // Gráfico de linha (últimos 7 dias)
            const ultimos7 = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(hoje);
                d.setDate(hoje.getDate() - i);
                ultimos7.push(d.toISOString().split('T')[0]);
            }
            const valoresPorDia = ultimos7.map(dia => 
                vendas.filter(v => v.data === dia).reduce((acc, v) => acc + v.total, 0)
            );

            if (window.graficoVendasLinha) window.graficoVendasLinha.destroy();
            const ctxLinha = document.getElementById('graficoVendasLinha').getContext('2d');
            window.graficoVendasLinha = new Chart(ctxLinha, {
                type: 'line',
                data: {
                    labels: ultimos7.map(d => d.substring(5)),
                    datasets: [{
                        label: 'VENDAS (R$)',
                        data: valoresPorDia,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Ranking dos produtos mais vendidos (por quantidade)
            const contagem = {};
            vendas.forEach(v => {
                v.itens.forEach(i => {
                    contagem[i.nome] = (contagem[i.nome] || 0) + i.quantidade;
                });
            });
            const sorted = Object.entries(contagem).sort((a,b) => b[1] - a[1]).slice(0,5);
            const nomes = sorted.map(s => s[0]);
            const quantidades = sorted.map(s => s[1]);

            if (window.graficoRanking) window.graficoRanking.destroy();
            const ctxRank = document.getElementById('graficoRanking').getContext('2d');
            window.graficoRanking = new Chart(ctxRank, {
                type: 'bar',
                data: {
                    labels: nomes,
                    datasets: [{
                        label: 'QUANTIDADE VENDIDA',
                        data: quantidades,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        }
    </script>
</body>
</html>
